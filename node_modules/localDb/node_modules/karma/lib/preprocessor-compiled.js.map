{"version":3,"sources":["preprocessor.js"],"names":[],"mappings":"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","file":"preprocessor-compiled.js","sourcesContent":["var path = require('path');\nvar fs = require('graceful-fs');\nvar crypto = require('crypto');\nvar mm = require('minimatch');\n\nvar log = require('./logger').create('preprocess');\n\nvar sha1 = function(data) {\n  var hash = crypto.createHash('sha1');\n  hash.update(data);\n  return hash.digest('hex');\n};\n\nvar isBinary = Object.create(null);\n[\n  'adp', 'au', 'mid', 'mp4a', 'mpga', 'oga', 's3m', 'sil', 'eol', 'dra', 'dts', 'dtshd', 'lvp',\n  'pya', 'ecelp4800', 'ecelp7470', 'ecelp9600', 'rip', 'weba', 'aac', 'aif', 'caf', 'flac', 'mka',\n  'm3u', 'wax', 'wma', 'wav', 'xm', 'flac', '3gp', '3g2', 'h261', 'h263', 'h264', 'jpgv', 'jpm',\n  'mj2', 'mp4', 'mpeg', 'ogv', 'qt', 'uvh', 'uvm', 'uvp', 'uvs', 'dvb', 'fvt', 'mxu', 'pyv', 'uvu',\n  'viv', 'webm', 'f4v', 'fli', 'flv', 'm4v', 'mkv', 'mng', 'asf', 'vob', 'wm', 'wmv', 'wmx', 'wvx',\n  'movie', 'smv', 'bmp', 'cgm', 'g3', 'gif', 'ief', 'jpg', 'jpeg', 'ktx', 'png', 'btif',\n  'sgi', 'tiff', 'psd', 'uvi', 'sub', 'djvu', 'dwg', 'dxf', 'fbs', 'fpx', 'fst', 'mmr',\n  'rlc', 'mdi', 'wdp', 'npx', 'wbmp', 'xif', 'webp', '3ds', 'ras', 'cmx', 'fh', 'ico', 'pcx', 'pic',\n  'pnm', 'pbm', 'pgm', 'ppm', 'rgb', 'tga', 'xbm', 'xpm', 'xwd', 'xz', 'zip', 'rar', 'tar', 'tbz2',\n  'tgz', 'txz', 'bz2', 'eot', 'ttf', 'woff', 'dat', 'nexe', 'pexe', 'epub', 'gz', 'mp3', 'ogg',\n  'swf', 'mem'\n].forEach(function(extension) {\n  isBinary['.' + extension] = true;\n});\n\n// TODO(vojta): instantiate preprocessors at the start to show warnings immediately\nvar createPreprocessor = function(config, basePath, injector) {\n  var alreadyDisplayedWarnings = Object.create(null);\n\n  return function(file, done) {\n    var patterns = Object.keys(config);\n    var thisFileIsBinary = isBinary[path.extname(file.originalPath)];\n    var preprocessors = [];\n    var nextPreprocessor = function(error, content) {\n      // normalize B-C\n      if (arguments.length === 1 && typeof error === 'string') {\n        content = error;\n        error = null;\n      }\n\n      if (error) {\n        file.content = null;\n        file.contentPath = null;\n        return done(error);\n      }\n\n      if (!preprocessors.length) {\n        file.contentPath = null;\n        file.content = content;\n        file.sha = sha1(content);\n        return done();\n      }\n\n      preprocessors.shift()(content, file, nextPreprocessor);\n    };\n    var instantiatePreprocessor = function(name) {\n      if (alreadyDisplayedWarnings[name]) {\n        return;\n      }\n\n      try {\n        preprocessors.push(injector.get('preprocessor:' + name));\n      } catch (e) {\n        if (e.message.indexOf('No provider for \"preprocessor:' + name + '\"') !== -1) {\n          log.warn('Can not load \"%s\", it is not registered!\\n  ' +\n                   'Perhaps you are missing some plugin?', name);\n        } else {\n          log.warn('Can not load \"%s\"!\\n  ' + e.stack, name);\n        }\n\n        alreadyDisplayedWarnings[name] = true;\n      }\n    };\n\n    // collects matching preprocessors\n    // TODO(vojta): should we cache this ?\n    for (var i = 0; i < patterns.length; i++) {\n      if (mm(file.originalPath, patterns[i])) {\n        if (thisFileIsBinary) {\n          log.warn('Ignoring preprocessing (%s) %s because it is a binary file.',\n              config[patterns[i]].join(', '), file.originalPath);\n        } else {\n          config[patterns[i]].forEach(instantiatePreprocessor);\n        }\n      }\n    }\n\n    return fs.readFile(file.originalPath, function(err, buffer) {\n      if (err) {\n        throw err;\n      }\n      nextPreprocessor(null, thisFileIsBinary ? buffer : buffer.toString());\n    });\n  };\n};\ncreatePreprocessor.$inject = ['config.preprocessors', 'config.basePath', 'injector'];\n\nexports.createPreprocessor = createPreprocessor;\n"]}