{"version":3,"sources":["proxy.js"],"names":[],"mappings":"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","file":"proxy-compiled.js","sourcesContent":["var url = require('url');\nvar httpProxy = require('http-proxy');\n\nvar log = require('../logger').create('proxy');\n\nvar parseProxyConfig = function(proxies, config) {\n  var proxyConfig = {};\n  var endsWithSlash = function(str) {\n    return str.substr(-1) === '/';\n  };\n\n  if (!proxies) {\n    return proxyConfig;\n  }\n\n  Object.keys(proxies).forEach(function(proxyPath) {\n    var proxyUrl = proxies[proxyPath];\n    var proxyDetails = url.parse(proxyUrl);\n    var pathname = proxyDetails.pathname;\n\n    // normalize the proxies config\n    // should we move this to lib/config.js ?\n    if (endsWithSlash(proxyPath) && !endsWithSlash(proxyUrl)) {\n      log.warn('proxy \"%s\" normalized to \"%s\"', proxyUrl, proxyUrl + '/');\n      proxyUrl += '/';\n      pathname += '/';\n    }\n\n    if (!endsWithSlash(proxyPath) && endsWithSlash(proxyUrl)) {\n      log.warn('proxy \"%s\" normalized to \"%s\"', proxyPath, proxyPath + '/');\n      proxyPath += '/';\n    }\n\n    if (pathname === '/'  && !endsWithSlash(proxyUrl)) {\n      pathname = '';\n    }\n\n    proxyConfig[proxyPath] = {\n      host: proxyDetails.hostname,\n      port: proxyDetails.port,\n      baseProxyUrl: pathname,\n      https: proxyDetails.protocol === 'https:'\n    };\n\n    if (!proxyConfig[proxyPath].port) {\n      if (!proxyConfig[proxyPath].host) {\n        proxyConfig[proxyPath].host = config.hostname;\n        proxyConfig[proxyPath].port = config.port;\n      } else {\n        proxyConfig[proxyPath].port = proxyConfig[proxyPath].https ? '443' : '80';\n      }\n    }\n  });\n\n  return proxyConfig;\n};\n\n\n/**\n * Returns a handler which understands the proxies and its redirects, along with the proxy to use\n * @param proxy A http-proxy.RoutingProxy object with the proxyRequest method\n * @param proxies a map of routes to proxy url\n * @return {Function} handler function\n */\nvar createProxyHandler = function(proxy, proxyConfig, proxyValidateSSL, urlRoot, config) {\n  var proxies = parseProxyConfig(proxyConfig, config);\n  var proxiesList = Object.keys(proxies).sort().reverse();\n\n  if (!proxiesList.length) {\n    var nullProxy = function createNullProxy(request, response, next) {\n      return next();\n    };\n    nullProxy.upgrade = function upgradeNullProxy() {\n    };\n    return nullProxy;\n  }\n\n  proxy.on('proxyError', function(err, req) {\n    if (err.code === 'ECONNRESET' && req.socket.destroyed) {\n      log.debug('failed to proxy %s (browser hung up the socket)', req.url);\n    } else {\n      log.warn('failed to proxy %s (%s)', req.url, err.message);\n    }\n  });\n\n  var middleware = function createProxy(request, response, next) {\n    for (var i = 0; i < proxiesList.length; i++) {\n      if (request.url.indexOf(proxiesList[i]) === 0) {\n        var proxiedUrl = proxies[proxiesList[i]];\n\n        log.debug('proxying request - %s to %s:%s', request.url, proxiedUrl.host, proxiedUrl.port);\n        request.url = request.url.replace(proxiesList[i], proxiedUrl.baseProxyUrl);\n        proxy.proxyRequest(request, response, {\n            host: proxiedUrl.host,\n            port: proxiedUrl.port,\n            target: {https: proxiedUrl.https, rejectUnauthorized: proxyValidateSSL}\n          });\n        return;\n      }\n    }\n\n    return next();\n  };\n\n  middleware.upgrade = function upgradeProxy(request, socket, head) {\n    // special-case karma's route to avoid upgrading it\n    if (request.url.indexOf(urlRoot) === 0) {\n      log.debug('NOT upgrading proxyWebSocketRequest %s', request.url);\n      return;\n    }\n    for (var i = 0; i < proxiesList.length; i++) {\n      if (request.url.indexOf(proxiesList[i]) === 0) {\n        var proxiedUrl = proxies[proxiesList[i]];\n        log.debug('upgrade proxyWebSocketRequest %s to %s:%s',\n          request.url, proxiedUrl.host, proxiedUrl.port);\n        proxy.proxyWebSocketRequest(request, socket, head,\n          {host: proxiedUrl.host, port: proxiedUrl.port});\n      }\n    }\n  };\n\n  return middleware;\n};\n\nvar createProxyHandlerFactory = function(/* config */ config, /* config.proxies */ proxies,\n  /* config.proxyValidateSSL */ validateSSL) {\n   return createProxyHandler(new httpProxy.RoutingProxy({changeOrigin: true}),\n    proxies, validateSSL, config.urlRoot, config);\n};\ncreateProxyHandlerFactory.$inject = ['config', 'config.proxies', 'config.proxyValidateSSL'];\n\nexports.create = createProxyHandlerFactory;\n"]}