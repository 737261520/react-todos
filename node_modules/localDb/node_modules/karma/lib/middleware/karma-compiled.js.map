{"version":3,"sources":["karma.js"],"names":[],"mappings":"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","file":"karma-compiled.js","sourcesContent":["/**\n * Karma middleware is responsible for serving:\n * - client.html (the entrypoint for capturing a browser)\n * - debug.html\n * - context.html (the execution context, loaded within an iframe)\n * - karma.js\n *\n * The main part is generating context.html, as it contains:\n * - generating mappings\n * - including <script> and <link> tags\n * - setting propert caching headers\n */\n\nvar path = require('path');\nvar util = require('util');\nvar url = require('url');\n\nvar urlparse = function(urlStr) {\n    var urlObj = url.parse(urlStr, true);\n    urlObj.query = urlObj.query || {};\n    return urlObj;\n};\n\nvar common = require('./common');\n\nvar VERSION = require('../constants').VERSION;\nvar SCRIPT_TAG = '<script type=\"%s\" src=\"%s\"></script>';\nvar LINK_TAG_CSS = '<link type=\"text/css\" href=\"%s\" rel=\"stylesheet\">';\nvar LINK_TAG_HTML = '<link href=\"%s\" rel=\"import\">';\nvar SCRIPT_TYPE = {\n  '.js': 'text/javascript',\n  '.dart': 'application/dart'\n};\n\nvar filePathToUrlPath = function(filePath, basePath) {\n  if (filePath.indexOf(basePath) === 0) {\n    return '/base' + filePath.substr(basePath.length);\n  }\n\n  return '/absolute' + filePath;\n};\n\nvar getXUACompatibleMetaElement = function(url) {\n  var tag = '';\n  var urlObj = urlparse(url);\n  if (urlObj.query['x-ua-compatible']) {\n    tag = '\\n<meta http-equiv=\"X-UA-Compatible\" content=\"' +\n     urlObj.query['x-ua-compatible'] + '\"/>';\n  }\n  return tag;\n};\n\nvar getXUACompatibleUrl = function(url) {\n  var value = '';\n  var urlObj = urlparse(url);\n  if (urlObj.query['x-ua-compatible']) {\n    value = '?x-ua-compatible=' + encodeURIComponent(urlObj.query['x-ua-compatible']);\n  }\n  return value;\n};\n\nvar createKarmaMiddleware = function(filesPromise, serveStaticFile,\n    /* config.basePath */ basePath,  /* config.urlRoot */ urlRoot, /* config.client */ client) {\n\n  return function(request, response, next) {\n    var requestUrl = request.normalizedUrl.replace(/\\?.*/, '');\n\n    // redirect /__karma__ to /__karma__ (trailing slash)\n    if (requestUrl === urlRoot.substr(0, urlRoot.length - 1)) {\n      response.setHeader('Location', urlRoot);\n      response.writeHead(301);\n      return response.end('MOVED PERMANENTLY');\n    }\n\n    // ignore urls outside urlRoot\n    if (requestUrl.indexOf(urlRoot) !== 0) {\n      return next();\n    }\n\n    // remove urlRoot prefix\n    requestUrl = requestUrl.substr(urlRoot.length - 1);\n\n    // serve client.html\n    if (requestUrl === '/') {\n      return serveStaticFile('/client.html', response, function(data) {\n        return data\n          .replace('\\n%X_UA_COMPATIBLE%', getXUACompatibleMetaElement(request.url))\n          .replace('%X_UA_COMPATIBLE_URL%', getXUACompatibleUrl(request.url));\n      });\n    }\n\n    // serve karma.js\n    if (requestUrl === '/karma.js') {\n      return serveStaticFile(requestUrl, response, function(data) {\n        return data.replace('%KARMA_URL_ROOT%', urlRoot)\n                   .replace('%KARMA_VERSION%', VERSION);\n      });\n    }\n\n    // serve context.html - execution context within the iframe\n    // or debug.html - execution context without channel to the server\n    if (requestUrl === '/context.html' || requestUrl === '/debug.html') {\n      return filesPromise.then(function(files) {\n        serveStaticFile(requestUrl, response, function(data) {\n          common.setNoCacheHeaders(response);\n\n          var scriptTags = files.included.map(function(file) {\n            var filePath = file.path;\n            var fileExt = path.extname(filePath);\n\n            if (!file.isUrl) {\n              // TODO(vojta): serve these files from within urlRoot as well\n              filePath = filePathToUrlPath(filePath, basePath);\n\n              if (requestUrl === '/context.html') {\n                filePath += '?' + file.sha;\n              }\n            }\n\n            if (fileExt === '.css') {\n              return util.format(LINK_TAG_CSS, filePath);\n            }\n\n            if (fileExt === '.html') {\n              return util.format(LINK_TAG_HTML, filePath);\n            }\n\n            return util.format(SCRIPT_TAG, SCRIPT_TYPE[fileExt] || 'text/javascript', filePath);\n          });\n\n          // TODO(vojta): don't compute if it's not in the template\n          var mappings = files.served.map(function(file) {\n            //Windows paths contain backslashes and generate bad IDs if not escaped\n            var filePath = filePathToUrlPath(file.path, basePath).replace(/\\\\/g,'\\\\\\\\');\n\n            return util.format('  \\'%s\\': \\'%s\\'', filePath, file.sha);\n          });\n\n          var clientConfig = '';\n\n          if (requestUrl === '/debug.html') {\n            clientConfig = 'window.__karma__.config = ' + JSON.stringify(client) + ';\\n';\n          }\n\n          mappings = 'window.__karma__.files = {\\n' + mappings.join(',\\n') + '\\n};\\n';\n\n          return data.\n            replace('%SCRIPTS%', scriptTags.join('\\n'))\n            .replace('%CLIENT_CONFIG%', clientConfig)\n            .replace('%MAPPINGS%', mappings)\n            .replace('\\n%X_UA_COMPATIBLE%', getXUACompatibleMetaElement(request.url));\n        });\n      }, function(errorFiles) {\n        serveStaticFile(requestUrl, response, function(data) {\n          common.setNoCacheHeaders(response);\n          return data.replace('%SCRIPTS%', '').replace('%CLIENT_CONFIG%', '').replace('%MAPPINGS%',\n              'window.__karma__.error(\"TEST RUN WAS CANCELLED because ' +\n              (errorFiles.length > 1 ? 'these files contain' : 'this file contains') +\n              ' some errors:\\\\n  ' + errorFiles.join('\\\\n  ') + '\");');\n        });\n      });\n    }\n\n    return next();\n  };\n};\n\ncreateKarmaMiddleware.$inject = ['filesPromise', 'serveStaticFile',\n  'config.basePath', 'config.urlRoot', 'config.client'];\n\n\n// PUBLIC API\nexports.create = createKarmaMiddleware;\n"]}