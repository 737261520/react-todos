{"version":3,"sources":["common.js"],"names":[],"mappings":"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","file":"common-compiled.js","sourcesContent":["/**\n * This module contains some common helpers shared between middlewares\n */\n\nvar mime = require('mime');\nvar log = require('../logger').create('web-server');\n\nvar PromiseContainer = function() {\n  var promise;\n\n  this.then = function(success, error) {\n    return promise.then(success, error);\n  };\n\n  this.set = function(newPromise) {\n    promise = newPromise;\n  };\n};\n\n\nvar serve404 = function(response, path) {\n  log.warn('404: ' + path);\n  response.writeHead(404);\n  return response.end('NOT FOUND');\n};\n\n\nvar createServeFile = function(fs, directory) {\n  var cache = Object.create(null);\n\n  return function(filepath, response, transform, content) {\n    var responseData;\n\n    if (directory) {\n      filepath = directory + filepath;\n    }\n\n    if (!content && cache[filepath]) {\n      content = cache[filepath];\n    }\n\n    // serve from cache\n    if (content) {\n      response.setHeader('Content-Type', mime.lookup(filepath, 'text/plain'));\n\n      // call custom transform fn to transform the data\n      responseData = transform && transform(content) || content;\n\n      response.writeHead(200);\n\n      log.debug('serving (cached): ' + filepath);\n      return response.end(responseData);\n    }\n\n    return fs.readFile(filepath, function(error, data) {\n      if (error) {\n        return serve404(response, filepath);\n      }\n\n      cache[filepath] = data.toString();\n\n      response.setHeader('Content-Type', mime.lookup(filepath, 'text/plain'));\n\n      // call custom transform fn to transform the data\n      responseData = transform && transform(data.toString()) || data;\n\n      response.writeHead(200);\n\n      log.debug('serving: ' + filepath);\n      return response.end(responseData);\n    });\n  };\n};\n\n\nvar setNoCacheHeaders = function(response) {\n  response.setHeader('Cache-Control', 'no-cache');\n  response.setHeader('Pragma', 'no-cache');\n  response.setHeader('Expires', (new Date(0)).toString());\n};\n\n\nvar setHeavyCacheHeaders = function(response) {\n  response.setHeader('Cache-Control', ['public', 'max-age=31536000']);\n};\n\n\n// PUBLIC API\nexports.PromiseContainer = PromiseContainer;\nexports.createServeFile = createServeFile;\nexports.setNoCacheHeaders = setNoCacheHeaders;\nexports.setHeavyCacheHeaders = setHeavyCacheHeaders;\nexports.serve404 = serve404;\n"]}