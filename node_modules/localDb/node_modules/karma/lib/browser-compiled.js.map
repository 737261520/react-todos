{"version":3,"sources":["browser.js"],"names":[],"mappings":"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","file":"browser-compiled.js","sourcesContent":["var helper = require('./helper');\nvar events = require('./events');\nvar logger = require('./logger');\n\nvar Result = require('./browser_result');\n\n\n// The browser is ready to execute tests.\nvar READY = 1;\n\n// The browser is executing the tests/\nvar EXECUTING = 2;\n\n// The browser is not executing, but temporarily disconnected (waiting for reconnecting).\nvar READY_DISCONNECTED = 3;\n\n// The browser is executing the tests, but temporarily disconnect (waiting for reconnecting).\nvar EXECUTING_DISCONNECTED = 4;\n\n// The browser got permanently disconnected (being removed from the collection and destroyed).\nvar DISCONNECTED = 5;\n\n\nvar Browser = function(id, fullName, /* capturedBrowsers */ collection, emitter, socket, timer,\n    /* config.browserDisconnectTimeout */ disconnectDelay,\n    /* config.browserNoActivityTimeout */ noActivityTimeout) {\n\n  var name = helper.browserFullNameToShort(fullName);\n  var log = logger.create(name);\n  var activeSockets = [socket];\n  var activeSocketsIds = function() {\n    return activeSockets.map(function(s) {\n      return s.id;\n    }).join(', ');\n  };\n\n  var self = this;\n  var pendingDisconnect;\n  var disconnect = function(reason) {\n    self.state = DISCONNECTED;\n    self.disconnectsCount++;\n    log.warn('Disconnected (%d times)' + (reason || ''), self.disconnectsCount);\n    collection.remove(self);\n  };\n\n  var noActivityTimeoutId;\n  var refreshNoActivityTimeout = noActivityTimeout ? function() {\n    clearNoActivityTimeout();\n    noActivityTimeoutId = timer.setTimeout(function() {\n      self.lastResult.totalTimeEnd();\n      self.lastResult.disconnected = true;\n      disconnect(', because no message in ' + noActivityTimeout + ' ms.');\n      emitter.emit('browser_complete', self);\n    }, noActivityTimeout);\n  } : function() {};\n\n  var clearNoActivityTimeout = noActivityTimeout ? function() {\n    if (noActivityTimeoutId) {\n      timer.clearTimeout(noActivityTimeoutId);\n      noActivityTimeoutId = null;\n    }\n  } : function() {};\n\n  this.id = id;\n  this.fullName = fullName;\n  this.name = name;\n  this.state = READY;\n  this.lastResult = new Result();\n  this.disconnectsCount = 0;\n\n  this.init = function() {\n    collection.add(this);\n\n    events.bindAll(this, socket);\n\n    log.info('Connected on socket %s with id %s', socket.id, id);\n\n    // TODO(vojta): move to collection\n    emitter.emit('browsers_change', collection);\n\n    emitter.emit('browser_register', this);\n  };\n\n  this.isReady = function() {\n    return this.state === READY;\n  };\n\n  this.toString = function() {\n    return this.name;\n  };\n\n  this.onError = function(error) {\n    if (this.isReady()) {\n      return;\n    }\n\n    this.lastResult.error = true;\n    emitter.emit('browser_error', this, error);\n\n    refreshNoActivityTimeout();\n  };\n\n  this.onInfo = function(info) {\n    if (this.isReady()) {\n      return;\n    }\n\n    // TODO(vojta): remove\n    if (helper.isDefined(info.dump)) {\n      emitter.emit('browser_log', this, info.dump, 'dump');\n    }\n\n    if (helper.isDefined(info.log)) {\n      emitter.emit('browser_log', this, info.log, info.type);\n    }\n\n    refreshNoActivityTimeout();\n  };\n\n  this.onStart = function(info) {\n    this.lastResult = new Result();\n    this.lastResult.total = info.total;\n\n    if (info.total === null) {\n      log.warn('Adapter did not report total number of specs.');\n    }\n\n    emitter.emit('browser_start', this, info);\n    refreshNoActivityTimeout();\n  };\n\n  this.onComplete = function(result) {\n    if (this.isReady()) {\n      return;\n    }\n\n    this.state = READY;\n    this.lastResult.totalTimeEnd();\n\n    if (!this.lastResult.success) {\n      this.lastResult.error = true;\n    }\n\n    emitter.emit('browsers_change', collection);\n    emitter.emit('browser_complete', this, result);\n\n    clearNoActivityTimeout();\n  };\n\n  this.onDisconnect = function(_, disconnectedSocket) {\n    activeSockets.splice(activeSockets.indexOf(disconnectedSocket), 1);\n\n    if (activeSockets.length) {\n      log.debug('Disconnected %s, still have %s', disconnectedSocket.id, activeSocketsIds());\n      return;\n    }\n\n    if (this.state === READY) {\n      disconnect();\n    } else if (this.state === EXECUTING) {\n      log.debug('Disconnected during run, waiting %sms for reconnecting.', disconnectDelay);\n      this.state = EXECUTING_DISCONNECTED;\n\n      pendingDisconnect = timer.setTimeout(function() {\n        self.lastResult.totalTimeEnd();\n        self.lastResult.disconnected = true;\n        disconnect();\n        emitter.emit('browser_complete', self);\n      }, disconnectDelay);\n\n      clearNoActivityTimeout();\n    }\n  };\n\n  this.reconnect = function(newSocket) {\n    if (this.state === EXECUTING_DISCONNECTED) {\n      this.state = EXECUTING;\n      log.debug('Reconnected on %s.', newSocket.id);\n    } else if (this.state === EXECUTING || this.state === READY) {\n      log.debug('New connection %s (already have %s)', newSocket.id, activeSocketsIds());\n    } else if (this.state === DISCONNECTED) {\n      this.state = READY;\n      log.info('Connected on socket %s with id %s', newSocket.id, this.id);\n      collection.add(this);\n\n      // TODO(vojta): move to collection\n      emitter.emit('browsers_change', collection);\n\n      emitter.emit('browser_register', this);\n    }\n\n    var exists = activeSockets.some(function(s) {\n      return s.id === newSocket.id;\n    });\n    if (!exists) {\n      activeSockets.push(newSocket);\n      events.bindAll(this, newSocket);\n    }\n\n    if (pendingDisconnect) {\n      timer.clearTimeout(pendingDisconnect);\n    }\n\n    refreshNoActivityTimeout();\n  };\n\n  this.onResult = function(result) {\n    if (result.length) {\n      return result.forEach(this.onResult, this);\n    }\n\n    // ignore - probably results from last run (after server disconnecting)\n    if (this.isReady()) {\n      return;\n    }\n\n    this.lastResult.add(result);\n\n    emitter.emit('spec_complete', this, result);\n    refreshNoActivityTimeout();\n  };\n\n  this.serialize = function() {\n    return {\n      id: this.id,\n      name: this.name,\n      isReady: this.state === READY\n    };\n  };\n\n  this.execute = function(config) {\n    activeSockets.forEach(function(socket) {\n      socket.emit('execute', config);\n    });\n\n    this.state = EXECUTING;\n    refreshNoActivityTimeout();\n  };\n};\n\nBrowser.STATE_READY = READY;\nBrowser.STATE_EXECUTING = EXECUTING;\nBrowser.STATE_READY_DISCONNECTED = READY_DISCONNECTED;\nBrowser.STATE_EXECUTING_DISCONNECTED = EXECUTING_DISCONNECTED;\nBrowser.STATE_DISCONNECTED = DISCONNECTED;\n\n\nmodule.exports = Browser;\n"]}