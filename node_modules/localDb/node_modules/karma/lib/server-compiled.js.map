{"version":3,"sources":["server.js"],"names":[],"mappings":"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","file":"server-compiled.js","sourcesContent":["var io = require('socket.io');\nvar di = require('di');\n\nvar cfg = require('./config');\nvar logger = require('./logger');\nvar constant = require('./constants');\nvar watcher = require('./watcher');\nvar plugin = require('./plugin');\n\nvar ws = require('./web-server');\nvar preprocessor = require('./preprocessor');\nvar Launcher = require('./launcher').Launcher;\nvar FileList = require('./file_list').List;\nvar reporter = require('./reporter');\nvar helper = require('./helper');\nvar events = require('./events');\nvar EventEmitter = events.EventEmitter;\nvar Executor = require('./executor');\nvar Browser = require('./browser');\nvar BrowserCollection = require('./browser_collection');\nvar EmitterWrapper = require('./emitter_wrapper');\nvar processWrapper = new EmitterWrapper(process);\n\nvar log = logger.create();\n\n\nvar start = function(injector, config, launcher, globalEmitter, preprocess, fileList, webServer,\n    capturedBrowsers, socketServer, executor, done) {\n\n  config.frameworks.forEach(function(framework) {\n    injector.get('framework:' + framework);\n  });\n\n  // A map of launched browsers.\n  var singleRunDoneBrowsers = Object.create(null);\n\n  // Passing fake event emitter, so that it does not emit on the global,\n  // we don't care about these changes.\n  var singleRunBrowsers = new BrowserCollection(new EventEmitter());\n\n  // Some browsers did not get captured.\n  var singleRunBrowserNotCaptured = false;\n\n  webServer.on('error', function(e) {\n    if (e.code === 'EADDRINUSE') {\n      log.warn('Port %d in use', config.port);\n      config.port++;\n      webServer.listen(config.port);\n    } else {\n      throw e;\n    }\n  });\n\n  var afterPreprocess = function() {\n    if (config.autoWatch) {\n      injector.invoke(watcher.watch);\n    }\n\n    webServer.listen(config.port, function() {\n      log.info('Karma v%s server started at http://%s:%s%s', constant.VERSION, config.hostname,\n          config.port, config.urlRoot);\n\n      if (config.browsers && config.browsers.length) {\n        injector.invoke(launcher.launch, launcher).forEach(function(browserLauncher) {\n          singleRunDoneBrowsers[browserLauncher.id] = false;\n        });\n      }\n    });\n  };\n\n  fileList.refresh().then(afterPreprocess, afterPreprocess);\n\n  globalEmitter.on('browsers_change', function() {\n    // TODO(vojta): send only to interested browsers\n    socketServer.sockets.emit('info', capturedBrowsers.serialize());\n  });\n\n  globalEmitter.on('browser_register', function(browser) {\n    launcher.markCaptured(browser.id);\n\n    // TODO(vojta): This is lame, browser can get captured and then crash (before other browsers get\n    // captured).\n    if (config.autoWatch && launcher.areAllCaptured()) {\n      executor.schedule();\n    }\n  });\n\n  var EVENTS_TO_REPLY = ['start', 'info', 'error', 'result', 'complete'];\n  socketServer.sockets.on('connection', function(socket) {\n    log.debug('A browser has connected on socket ' + socket.id);\n\n    var replySocketEvents = events.bufferEvents(socket, EVENTS_TO_REPLY);\n\n    socket.on('complete', function(data, ack) {\n      ack();\n    });\n\n    socket.on('register', function(info) {\n      var newBrowser;\n      var isRestart;\n\n      if (info.id) {\n        newBrowser = capturedBrowsers.getById(info.id) || singleRunBrowsers.getById(info.id);\n      }\n\n      if (newBrowser) {\n        isRestart = newBrowser.state === Browser.STATE_DISCONNECTED;\n        newBrowser.reconnect(socket);\n\n        // We are restarting a previously disconnected browser.\n        if (isRestart && config.singleRun) {\n          newBrowser.execute(config.client);\n        }\n      } else {\n        newBrowser = injector.createChild([{\n          id: ['value', info.id || null],\n          fullName: ['value', info.name],\n          socket: ['value', socket]\n        }]).instantiate(Browser);\n\n        newBrowser.init();\n\n        // execute in this browser immediately\n        if (config.singleRun) {\n          newBrowser.execute(config.client);\n          singleRunBrowsers.add(newBrowser);\n        }\n      }\n\n      replySocketEvents();\n    });\n  });\n\n  var emitRunCompleteIfAllBrowsersDone = function() {\n    // all browsers done\n    var isDone = Object.keys(singleRunDoneBrowsers).reduce(function(isDone, id) {\n      return isDone && singleRunDoneBrowsers[id];\n    }, true);\n\n    if (isDone) {\n      var results = singleRunBrowsers.getResults();\n      if (singleRunBrowserNotCaptured) {\n        results.exitCode = 1;\n      }\n\n      globalEmitter.emit('run_complete', singleRunBrowsers, results);\n    }\n  };\n\n  if (config.singleRun) {\n    globalEmitter.on('browser_complete', function(completedBrowser) {\n      if (completedBrowser.lastResult.disconnected &&\n          completedBrowser.disconnectsCount <= config.browserDisconnectTolerance) {\n        log.info('Restarting %s (%d of %d attempts)', completedBrowser.name,\n            completedBrowser.disconnectsCount, config.browserDisconnectTolerance);\n        if (!launcher.restart(completedBrowser.id)) {\n          singleRunDoneBrowsers[completedBrowser.id] = true;\n          emitRunCompleteIfAllBrowsersDone();\n        }\n      } else {\n        singleRunDoneBrowsers[completedBrowser.id] = true;\n\n        if (launcher.kill(completedBrowser.id)) {\n          // workaround to supress \"disconnect\" warning\n          completedBrowser.state = Browser.STATE_DISCONNECTED;\n        }\n\n        emitRunCompleteIfAllBrowsersDone();\n      }\n    });\n\n    globalEmitter.on('browser_process_failure', function(browserLauncher) {\n      singleRunDoneBrowsers[browserLauncher.id] = true;\n      singleRunBrowserNotCaptured = true;\n\n      emitRunCompleteIfAllBrowsersDone();\n    });\n\n    globalEmitter.on('run_complete', function(browsers, results) {\n      log.debug('Run complete, exiting.');\n      disconnectBrowsers(results.exitCode);\n    });\n\n    globalEmitter.emit('run_start', singleRunBrowsers);\n  }\n\n\n  if (config.autoWatch) {\n    globalEmitter.on('file_list_modified', function() {\n      log.debug('List of files has changed, trying to execute');\n      executor.schedule();\n    });\n  }\n\n  var webServerCloseTimeout = 3000;\n  var disconnectBrowsers = function(code) {\n    // Slightly hacky way of removing disconnect listeners\n    // to suppress \"browser disconnect\" warnings\n    // TODO(vojta): change the client to not send the event (if disconnected by purpose)\n    var sockets = socketServer.sockets.sockets;\n    Object.getOwnPropertyNames(sockets).forEach(function(key) {\n      var socket = sockets[key];\n      socket.removeAllListeners('disconnect');\n      if (!socket.disconnected) {\n        socket.disconnect();\n      }\n    });\n\n    var removeAllListenersDone = false;\n    var removeAllListeners = function() {\n      // make sure we don't execute cleanup twice\n      if (removeAllListenersDone) {\n        return;\n      }\n      removeAllListenersDone = true;\n      webServer.removeAllListeners();\n      processWrapper.removeAllListeners();\n      done(code || 0);\n    };\n\n    globalEmitter.emitAsync('exit').then(function() {\n      // don't wait forever on webServer.close() because\n      // pending client connections prevent it from closing.\n      var closeTimeout = setTimeout(removeAllListeners, webServerCloseTimeout);\n\n      // shutdown the server...\n      webServer.close(function() {\n        clearTimeout(closeTimeout);\n        removeAllListeners();\n      });\n\n      // shutdown socket.io flash transport, if defined\n      if (socketServer.flashPolicyServer) {\n        socketServer.flashPolicyServer.close();\n      }\n    });\n  };\n\n  try {\n    processWrapper.on('SIGINT', disconnectBrowsers);\n    processWrapper.on('SIGTERM', disconnectBrowsers);\n  } catch (e) {\n    // Windows doesn't support signals yet, so they simply don't get this handling.\n    // https://github.com/joyent/node/issues/1553\n  }\n\n  // Handle all unhandled exceptions, so we don't just exit but\n  // disconnect the browsers before exiting.\n  processWrapper.on('uncaughtException', function(error) {\n    log.error(error);\n    disconnectBrowsers(1);\n  });\n};\nstart.$inject = ['injector', 'config', 'launcher', 'emitter', 'preprocess', 'fileList',\n    'webServer', 'capturedBrowsers', 'socketServer', 'executor', 'done'];\n\n\nvar createSocketIoServer = function(webServer, executor, config) {\n  var server = io.listen(webServer, {\n    // avoid destroying http upgrades from socket.io to get proxied websockets working\n    'destroy upgrade': false,\n    // socket.io has a timeout (15s by default) before destroying a store (a data structure where\n    // data associated with a socket are stored). Unfortunately this timeout is not cleared\n    // properly on socket.io shutdown and this timeout prevents karma from exiting cleanly.\n    // We change this timeout to 0 to make Karma exit just after all tests were executed.\n    'client store expiration': 0,\n    logger: logger.create('socket.io', constant.LOG_ERROR),\n    resource: config.urlRoot + 'socket.io',\n    transports: config.transports\n  });\n\n  // hack to overcome circular dependency\n  executor.socketIoSockets = server.sockets;\n\n  return server;\n};\n\n\nexports.start = function(cliOptions, done) {\n  // apply the default logger config (and config from CLI) as soon as we can\n  logger.setup(cliOptions.logLevel || constant.LOG_INFO,\n      helper.isDefined(cliOptions.colors) ? cliOptions.colors : true, [constant.CONSOLE_APPENDER]);\n\n  var config = cfg.parseConfig(cliOptions.configFile, cliOptions);\n  var modules = [{\n    helper: ['value', helper],\n    logger: ['value', logger],\n    done: ['value', done || process.exit],\n    emitter: ['type', EventEmitter],\n    launcher: ['type', Launcher],\n    config: ['value', config],\n    preprocess: ['factory', preprocessor.createPreprocessor],\n    fileList: ['type', FileList],\n    webServer: ['factory', ws.create],\n    socketServer: ['factory', createSocketIoServer],\n    executor: ['type', Executor],\n    // TODO(vojta): remove\n    customFileHandlers: ['value', []],\n    // TODO(vojta): remove, once karma-dart does not rely on it\n    customScriptTypes: ['value', []],\n    reporter: ['factory', reporter.createReporters],\n    capturedBrowsers: ['type', BrowserCollection],\n    args: ['value', {}],\n    timer: ['value', {setTimeout: setTimeout, clearTimeout: clearTimeout}]\n  }];\n\n  // load the plugins\n  modules = modules.concat(plugin.resolve(config.plugins));\n\n  var injector = new di.Injector(modules);\n\n  injector.invoke(start);\n};\n"]}