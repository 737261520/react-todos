{"version":3,"sources":["launcher.js"],"names":[],"mappings":"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","file":"launcher-compiled.js","sourcesContent":["var log = require('./logger').create('launcher');\nvar q = require('q');\n\nvar baseDecorator = require('./launchers/base').decoratorFactory;\nvar captureTimeoutDecorator = require('./launchers/capture_timeout').decoratorFactory;\nvar retryDecorator = require('./launchers/retry').decoratorFactory;\nvar processDecorator = require('./launchers/process').decoratorFactory;\n\n\n// TODO(vojta): remove once nobody uses it\nvar baseBrowserDecoratorFactory = function(baseLauncherDecorator, captureTimeoutLauncherDecorator,\n    retryLauncherDecorator, processLauncherDecorator) {\n  return function(launcher) {\n    baseLauncherDecorator(launcher);\n    captureTimeoutLauncherDecorator(launcher);\n    retryLauncherDecorator(launcher);\n    processLauncherDecorator(launcher);\n  };\n};\n\nvar Launcher = function(emitter, injector) {\n  var browsers = [];\n  var lastStartTime;\n\n  var getBrowserById = function(id) {\n    for (var i = 0; i < browsers.length; i++) {\n      if (browsers[i].id === id) {\n        return browsers[i];\n      }\n    }\n\n    return null;\n  };\n\n  this.launch = function(names, hostname, port, urlRoot) {\n    var browser;\n    var url = 'http://' + hostname + ':' + port + urlRoot;\n\n    lastStartTime = Date.now();\n\n    names.forEach(function(name) {\n      var locals = {\n        id: ['value', Launcher.generateId()],\n        name: ['value', name],\n        baseLauncherDecorator: ['factory', baseDecorator],\n        captureTimeoutLauncherDecorator: ['factory', captureTimeoutDecorator],\n        retryLauncherDecorator: ['factory', retryDecorator],\n        processLauncherDecorator: ['factory', processDecorator],\n        baseBrowserDecorator: ['factory', baseBrowserDecoratorFactory]\n      };\n\n      // TODO(vojta): determine script from name\n      if (name.indexOf('/') !== -1) {\n        name = 'Script';\n      }\n\n      try {\n        browser = injector.createChild([locals], ['launcher:' + name]).get('launcher:' + name);\n      } catch (e) {\n        if (e.message.indexOf('No provider for \"launcher:' + name + '\"') !== -1) {\n          log.warn('Can not load \"%s\", it is not registered!\\n  ' +\n                   'Perhaps you are missing some plugin?', name);\n        } else {\n          log.warn('Can not load \"%s\"!\\n  ' + e.stack, name);\n        }\n\n        return;\n      }\n\n      // TODO(vojta): remove in v1.0 (BC for old launchers)\n      if (!browser.forceKill) {\n        browser.forceKill = function() {\n          var deferred = q.defer();\n          this.kill(function() {\n            deferred.resolve();\n          });\n          return deferred.promise;\n        };\n\n        browser.restart = function() {\n          var self = this;\n          this.kill(function() {\n            self.start(url);\n          });\n        };\n      }\n\n      log.info('Starting browser %s', browser.name);\n      browser.start(url);\n      browsers.push(browser);\n    });\n\n    return browsers;\n  };\n\n  this.launch.$inject = ['config.browsers', 'config.hostname', 'config.port', 'config.urlRoot'];\n\n\n  this.kill = function(id, callback) {\n    var browser = getBrowserById(id);\n    callback = callback || function() {};\n\n    if (!browser) {\n      process.nextTick(callback);\n      return false;\n    }\n\n    browser.forceKill().then(callback);\n    return true;\n  };\n\n\n  this.restart = function(id) {\n    var browser = getBrowserById(id);\n\n    if (!browser) {\n      return false;\n    }\n\n    browser.restart();\n    return true;\n  };\n\n\n  this.killAll = function(callback) {\n    log.debug('Disconnecting all browsers');\n\n    var remaining = 0;\n    var finish = function() {\n      remaining--;\n      if (!remaining && callback) {\n        callback();\n      }\n    };\n\n    if (!browsers.length) {\n      return process.nextTick(callback);\n    }\n\n    browsers.forEach(function(browser) {\n      remaining++;\n      browser.forceKill().then(finish);\n    });\n  };\n\n\n  this.areAllCaptured = function() {\n    return !browsers.some(function(browser) {\n      return !browser.isCaptured();\n    });\n  };\n\n\n  this.markCaptured = function(id) {\n    browsers.forEach(function(browser) {\n      if (browser.id === id) {\n        browser.markCaptured();\n        log.debug('%s (id %s) captured in %d secs', browser.name, browser.id,\n            (Date.now() - lastStartTime) / 1000);\n      }\n    });\n  };\n\n\n  // register events\n  emitter.on('exit', this.killAll);\n};\n\nLauncher.$inject = ['emitter', 'injector'];\n\nLauncher.generateId = function() {\n  return '' + Math.floor(Math.random() * 100000000);\n};\n\n\n// PUBLISH\nexports.Launcher = Launcher;\n"]}