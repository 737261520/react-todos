{"version":3,"sources":["process.js"],"names":[],"mappings":"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","file":"process-compiled.js","sourcesContent":["var path = require('path');\nvar log = require('../logger').create('launcher');\nvar env = process.env;\n\nvar ProcessLauncher = function(spawn, tempDir, timer) {\n\n  var self = this;\n  var onExitCallback;\n  var killTimeout = 2000;\n\n  this._tempDir = tempDir.getPath('/karma-' + this.id.toString());\n\n  this.on('start', function(url) {\n    tempDir.create(self._tempDir);\n    self._start(url);\n  });\n\n  this.on('kill', function(done) {\n    if (!self._process) {\n      return process.nextTick(done);\n    }\n\n    onExitCallback = done;\n    self._process.kill();\n    self._killTimer = timer.setTimeout(self._onKillTimeout, killTimeout);\n  });\n\n  this._start = function(url) {\n    self._execCommand(self._getCommand(), self._getOptions(url));\n  };\n\n  this._getCommand = function() {\n    return env[self.ENV_CMD] || self.DEFAULT_CMD[process.platform];\n  };\n\n  this._getOptions = function(url) {\n    return [url];\n  };\n\n  // Normalize the command, remove quotes (spawn does not like them).\n  this._normalizeCommand = function(cmd) {\n    if (cmd.charAt(0) === cmd.charAt(cmd.length - 1) && '\\'`\"'.indexOf(cmd.charAt(0)) !== -1) {\n      cmd = cmd.substring(1, cmd.length - 1);\n      log.warn('The path should not be quoted.\\n  Normalized the path to %s', cmd);\n    }\n\n    return path.normalize(cmd);\n  };\n\n  this._execCommand = function(cmd, args) {\n    if (!cmd) {\n      log.error('No binary for %s browser on your platform.\\n  ' +\n                'Please, set \"%s\" env variable.', self.name, self.ENV_CMD);\n\n      self._retryLimit = -1; // disable restarting\n\n      return self._clearTempDirAndReportDone('no binary');\n    }\n\n    cmd = this._normalizeCommand(cmd);\n\n    log.debug(cmd + ' ' + args.join(' '));\n    self._process = spawn(cmd, args);\n\n    var errorOutput = '';\n\n    self._process.on('close', function(code) {\n      self._onProcessExit(code, errorOutput);\n    });\n\n    self._process.on('error', function(err) {\n      if (err.code === 'ENOENT') {\n        self._retryLimit = -1;\n        errorOutput = 'Can not find the binary ' + cmd + '\\n\\t' +\n                      'Please set env variable ' + self.ENV_CMD;\n      } else {\n        errorOutput += err.toString();\n      }\n    });\n\n    // Node 0.8 does not emit the error\n    if (process.versions.node.indexOf('0.8') === 0) {\n      self._process.stderr.on('data', function(data) {\n        var msg = data.toString();\n\n        if (msg.indexOf('No such file or directory') !== -1) {\n          self._retryLimit = -1;\n          errorOutput = 'Can not find the binary ' + cmd + '\\n\\t' +\n                        'Please set env variable ' + self.ENV_CMD;\n        } else {\n          errorOutput += msg;\n        }\n      });\n    }\n  };\n\n  this._onProcessExit = function(code, errorOutput) {\n    log.debug('Process %s exited with code %d', self.name, code);\n\n    var error = null;\n\n    if (self.state === self.STATE_BEING_CAPTURED) {\n      log.error('Cannot start %s\\n\\t%s', self.name, errorOutput);\n      error = 'cannot start';\n    }\n\n    if (self.state === self.STATE_CAPTURED) {\n      log.error('%s crashed.\\n\\t%s', self.name, errorOutput);\n      error = 'crashed';\n    }\n\n    self._process = null;\n    if (self._killTimer) {\n      timer.clearTimeout(self._killTimer);\n      self._killTimer = null;\n    }\n    self._clearTempDirAndReportDone(error);\n  };\n\n  this._clearTempDirAndReportDone = function(error) {\n    tempDir.remove(self._tempDir, function() {\n      self._done(error);\n      if (onExitCallback) {\n        onExitCallback();\n        onExitCallback = null;\n      }\n    });\n  };\n\n  this._onKillTimeout = function() {\n    if (self.state !== self.STATE_BEING_KILLED) {\n      return;\n    }\n\n    log.warn('%s was not killed in %d ms, sending SIGKILL.', self.name, killTimeout);\n    self._process.kill('SIGKILL');\n\n    // NOTE: https://github.com/karma-runner/karma/pull/1184\n    // NOTE: SIGKILL is just a signal.  Processes should never ignore it, but they can.\n    // If a process gets into a state where it doesn't respond in a reasonable amout of time\n    // Karma should warn, and continue as though the kill succeeded.\n    // This a certainly suboptimal, but it is better than having the test harness hang waiting\n    // for a zombie child process to exit.\n    self._killTimer = timer.setTimeout(function() {\n      log.warn('%s was not killed by SIGKILL in %d ms, continuing.', self.name, killTimeout);\n      self._onProcessExit(-1, '');\n    }, killTimeout);\n  };\n};\n\nProcessLauncher.decoratorFactory = function(timer) {\n  return function(launcher) {\n    ProcessLauncher.call(launcher, require('child_process').spawn, require('../temp_dir'), timer);\n  };\n};\n\n\nmodule.exports = ProcessLauncher;\n"]}