{"version":3,"sources":["web-server.js"],"names":[],"mappings":"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","file":"web-server-compiled.js","sourcesContent":["var fs = require('fs');\nvar http = require('http');\nvar path = require('path');\nvar connect = require('connect');\n\nvar common = require('./middleware/common');\nvar runnerMiddleware = require('./middleware/runner');\nvar stripHostMiddleware = require('./middleware/strip_host');\nvar karmaMiddleware = require('./middleware/karma');\nvar sourceFilesMiddleware = require('./middleware/source_files');\nvar proxyMiddleware = require('./middleware/proxy');\n\nvar log = require('./logger').create('web-server');\n\nvar createCustomHandler = function(customFileHandlers, /* config.basePath */ basePath) {\n  return function(request, response, next) {\n    for (var i = 0; i < customFileHandlers.length; i++) {\n      if (customFileHandlers[i].urlRegex.test(request.url)) {\n        return customFileHandlers[i].handler(request, response, 'fake/static', 'fake/adapter',\n            basePath, 'fake/root');\n      }\n    }\n\n    return next();\n  };\n};\n\ncreateCustomHandler.$inject = ['customFileHandlers', 'config.basePath'];\n\n\nvar createWebServer = function(injector, emitter) {\n  var serveStaticFile = common.createServeFile(fs, path.normalize(__dirname + '/../static'));\n  var serveFile = common.createServeFile(fs);\n  var filesPromise = new common.PromiseContainer();\n\n  emitter.on('file_list_modified', function(files) {\n    filesPromise.set(files);\n  });\n\n  // locals for webserver module\n  // NOTE(vojta): figure out how to do this with DI\n  injector = injector.createChild([{\n    serveFile: ['value', serveFile],\n    serveStaticFile: ['value', serveStaticFile],\n    filesPromise: ['value', filesPromise]\n  }]);\n\n  var proxyMiddlewareInstance = injector.invoke(proxyMiddleware.create);\n\n  var handler = connect()\n      .use(injector.invoke(runnerMiddleware.create))\n      .use(injector.invoke(stripHostMiddleware.create))\n      .use(injector.invoke(karmaMiddleware.create))\n      .use(injector.invoke(sourceFilesMiddleware.create))\n      // TODO(vojta): extract the proxy into a plugin\n      .use(proxyMiddlewareInstance)\n      // TODO(vojta): remove, this is only here because of karma-dart\n      // we need a better way of custom handlers\n      .use(injector.invoke(createCustomHandler))\n      .use(function(request, response) {\n        common.serve404(response, request.url);\n      });\n\n  var server = http.createServer(handler);\n\n  server.on('upgrade', function(req, socket, head) {\n    log.debug('upgrade %s', req.url);\n    proxyMiddlewareInstance.upgrade(req, socket, head);\n  });\n\n  return server;\n};\n\n\n// PUBLIC API\nexports.create = createWebServer;\n"]}